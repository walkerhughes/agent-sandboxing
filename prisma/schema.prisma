generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Chat sessions (user's conversation thread)
model ChatSession {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  messages ChatMessage[]
  tasks    AgentTask[]

  @@map("chat_sessions")
}

// Chat messages (regular chat, not agent tasks)
model ChatMessage {
  id        String   @id @default(uuid())
  sessionId String   @map("session_id")
  role      String   // 'user' or 'assistant'
  content   String
  createdAt DateTime @default(now()) @map("created_at")

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}

// Agent tasks (action mode executions)
model AgentTask {
  id        String   @id @default(uuid())
  sessionId String   @map("session_id")

  // Task state
  status TaskStatus @default(pending)

  // Claude Agent SDK session (this is ALL we need for resume!)
  agentSessionId String? @map("agent_session_id")

  // Original task
  taskPrompt String @map("task_prompt")

  // Clarification state
  pendingClarification Json? @map("pending_clarification")
  // Schema: { question: string, context: string, options?: string[] }

  // Status updates (append-only log)
  statusUpdates Json[] @default([]) @map("status_updates")
  // Schema: { message: string, timestamp: string, tool?: string }

  // Final result
  result Json?
  // Schema: { summary: string, actions_taken: string[], files_created?: string[] }

  // Execution tracking
  executionSegment Int @default(1) @map("execution_segment")

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  completedAt DateTime? @map("completed_at")

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, status])
  @@map("agent_tasks")
}

enum TaskStatus {
  pending
  running
  awaiting_input
  completed
  failed
  cancelled
}
